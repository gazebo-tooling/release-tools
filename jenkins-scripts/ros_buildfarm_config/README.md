# ros_buildfam configuration for the Gazebo buildfarm

This directory hosts the ros_buildfarm configuration used to create some jobs
in the Gazebo buildfarm. Mostly inspired by the ROS buildfarm configuration
repository: https://github.com/ros2/ros_buildfarm_config/

## Rationale

The [ros_buildfarm](https://github.com/ros-infrastructure/ros_buildfarm) code
is able to generate Jenkins jobs designed mainly for the ROS buildfarm that
are also applicable to other Jenkins buildfarms. In this case the Gazebo
development team was looking for a colcon based jobs able to receive
as an input a VCS file. Instead of creating these jobs from scratch, the use of
ros_buildfarm was chosen to provide the required features and many others more.

## Jobs generated

The jobs generated by ros_buildfarm are easily recognizable since they are
placed under the Jenkins views `ci`. The job names also use the same
prefix: `ci__`

## Input needed and the lack of ROS repositories

The jobs are configured to use the `packages.osrfoundation.org` and the
[osrf-rosdep](https://github.com/osrf/osrf-rosdep) keys repository so the
jobs are expected to resolved and install dependencies from the
`packages.osrfoundation.org` repository and Ubuntu official repositories.

In the case of testing a **ROS package** (like the `gz_*_vendor` repositories)
it is necessary to input a .repos file that contains all the dependencies
from the ROS ecosystem to be built from source. To auomate that process the
`rosdistro` tool can be used:

```
# Example using ROS 2 ROlling and gz_launch_vendor
rosinstall_generator --format repos --upstream-development --rosdistro rolling  --deps  gz_launch_vendor
```

## Generating jobs

### Initial setup

Be sure of going through the
[Setup environment to deploy configuration](https://github.com/ros-infrastructure/ros_buildfarm/blob/master/doc/environment.rst)
document in the ros_buildfarm as the first step to proceed with the jobs
generation.

### Running job generation

Note that the Gazebo buildfarm can not execute the script
`ros_buildfarm/scripts/generate_all_jobs.py` since it will create some
maintenance views and jobs that are not in the scope of this buildfarm.

Instead of that, the job generation is done manually per configuration
file using the following (empty quotes are mandatory):

```
# remove the --dry-run for real execution
./generate_ci_jobs.py --dry-run \
    https://raw.githubusercontent.com/gazebo-tooling/release-tools/master/jenkins-scripts/ros_buildfarm_config/index.yaml \
    "" <ci_build>
```

The different `<ci_build>` are defined in the index file just before the key
`ci_builds:`. So for example

```
# remove the --dry-run for real execution
./generate_ci_jobs.py --dry-run \
    https://raw.githubusercontent.com/gazebo-tooling/release-tools/master/jenkins-scripts/ros_buildfarm_config/index.yaml \
    "" colcon_any-manual
```

To automate the process using the `yq` tool:

```
wget https://raw.githubusercontent.com/gazebo-tooling/release-tools/master/jenkins-scripts/ros_buildfarm_config/index.yaml
for ci_build in $(yq -r '.ci_builds | keys[]' index.yaml); do
./generate_ci_jobs.py --dry-run \
    https://raw.githubusercontent.com/gazebo-tooling/release-tools/master/jenkins-scripts/ros_buildfarm_config/index.yaml \
    "" $ci_build
done
```
