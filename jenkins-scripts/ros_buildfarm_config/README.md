# ros_buildfam configuration for the Gazebo buildfarm

This directory hosts the ros_buildfarm configuration used to create some jobs
in the Gazebo buildfarm. Mostly inspired by the ROS buildfarm configuration 
repository: https://github.com/ros2/ros_buildfarm_config/

## Rationale

The [ros_buildfarm](https://github.com/ros-infrastructure/ros_buildfarm) code 
is able to generate Jenkins jobs designed mainly for the ROS buildfarm that 
are also applicable to other Jenkins buildfarms. In this case the Gazebo
development team was looking for a colcon based jobs able to receive
as an input a VCS file. Instead of creating these jobs from scratch, the use of
ros_buildfarm was chosen to provide the required features and many others more.

## Jobs generated

The jobs generated by ros_buildfarm are easily recognizable since they are 
placed under the Jenkins views `ci` (non ROS related jobs) or `Xci` 
(where X is the initial of a ROS release). The job names also uses these
same prefixes: `ci__` or `Xci__`.

## Generating jobs

### Initial setup

Be sure of going through the 
[Setup environment to deploy configuration](https://github.com/ros-infrastructure/ros_buildfarm/blob/master/doc/environment.rst)
document in the ros_buildfarm as the first step to proceed with the jobs
generation.

### Running job generation

Note that the Gazebo buildfarm can not execute the script
`ros_buildfarm/scripts/generate_all_jobs.py` since it will create some
maintenance views and jobs that are not in the scope of this buildfarm.

Instead of that, the job generation is done manually per configuration
file using the following (empty quotes are mandatory):

```
# remove the --dry-run for real execution
./generate_ci_jobs.py --dry-run \
    https://raw.githubusercontent.com/gazebo-tooling/release-tools/jrivero/ros_buildfarm/jenkins-scripts/ros_buildfarm_config/index.yaml \
    "" <ci_build>
```

The different `<ci_build>` are defined in the index file just before the key
`ci_builds:`. So for example 

```
# remove the --dry-run for real execution
./generate_ci_jobs.py --dry-run \
    https://raw.githubusercontent.com/gazebo-tooling/release-tools/jrivero/ros_buildfarm/jenkins-scripts/ros_buildfarm_config/index.yaml \
    "" colcon_any-manual
```

To automate the process using the `yq` tool:

```
wget https://raw.githubusercontent.com/gazebo-tooling/release-tools/master/jenkins-scripts/ros_buildfarm_config/index.yaml
for ci_build in $(yq '.ci_builds | keys' < index.yaml | sed 's:^- ::'); do 
./generate_ci_jobs.py --dry-run \
    https://raw.githubusercontent.com/gazebo-tooling/release-tools/jrivero/ros_buildfarm/jenkins-scripts/ros_buildfarm_config/index.yaml \
    "" $ci_build
done
```
